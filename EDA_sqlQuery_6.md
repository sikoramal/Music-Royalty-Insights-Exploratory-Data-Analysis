## Analysis 6: 
sqlQuery 6 â€“ FULL STACK   <br>
 <br>

### Query
````sql
SELECT TOP 5 *
FROM  royalty_sales ; 

-- 1. Calculate the total sales and revenue per album 
SELECT a.album_title, 
		COUNT(rs.sale_id) AS total_sales, 
		ROUND( SUM(rs.usd_payable), 2)  AS total_revenue  
FROM albums as a 
JOIN royalty_sales as rs
ON a.album_id = rs.album_id 
GROUP BY a.album_title 
ORDER BY total_revenue desc;

-- 2. Artists with the maximum number of albums 
SELECT real_name, COUNT(album_id) as album_count
FROM albums as a
JOIN artists as ar
ON a.artist_id = ar.artist_id 
GROUP BY real_name
ORDER BY album_count DESC ; 

-- 3. What month has the most sales 
SELECT TOP 5 FORMAT(sale_date, 'MMMM') AS month_name, 
		SUM (quantity) AS total_sales
FROM royalty_sales
GROUP BY FORMAT(sale_date, 'MMMM')
ORDER BY total_sales desc ; 

-- 4. let's say I want to know the same but between dates 

WITH total_sales_cte AS (
SELECT FORMAT(sale_date, 'MMMM') AS month_name, 
		SUM (quantity) AS total_sales
FROM royalty_sales
WHERE sale_date BETWEEN '2020-01-01' AND 
	(	SELECT TOP 1 sale_date
		FROM royalty_sales
		ORDER BY sale_date DESC )
GROUP BY FORMAT(sale_date, 'MMMM')
 )

SELECT TOP 5 month_name, total_sales
FROM total_sales_cte 
ORDER BY total_sales desc ; 


-- 5. Genres with the highest sales quantity 
-- *** genre (albums) || quantity (rs) ***
SELECT genre, SUM(quantity) as total_sales
FROM royalty_sales as rs
JOIN albums as a
ON rs.album_id = a.album_id
WHERE genre IS NOT NULL
GROUP BY genre
ORDER BY total_sales desc ; 



-- 6. Total revenue generated by each artists, considering royalty share and sales quantity
-- *** artistID (ar) || name (ar) || revenue(rs) ***
SELECT ar.artist_id, 
	ar.artist_name, 
	ar.real_name,
	SUM(a.royalty_share * rs.quantity * rs.usd_payable) as total_revenueUSD
FROM artists as ar
JOIN albums as a
ON ar.artist_id = a.artist_id 
JOIN royalty_sales as rs 
ON a.album_id = rs.album_id
GROUP BY ar.artist_id, ar.artist_name, ar.real_name 
ORDER BY total_revenueUSD desc	;

-- 7. What artists has the highest average royalty share
-- *** avg(royalty share) | artist id | artist name | real name *** 
SELECT a.artist_id, ar.real_name, ar.artist_name, 
		AVG(a.royalty_share) AS avg_royalty_share
FROM albums as a
JOIN artists as ar
ON a.artist_id = ar.artist_id
GROUP BY a.artist_id, ar.artist_id, ar.real_name, ar.artist_name 
ORDER BY avg_royalty_share DESC 
;
-- 8. Finding the store with most diverse range of genres 
-- ** rs.store | a.genre via albumID 
SELECT rs.store, 
		COUNT(DISTINCT a.genre) AS genre_count
FROM royalty_sales as rs
LEFT JOIN albums as a
ON rs.album_id = a.album_id 
GROUP BY rs.store
ORDER BY genre_count DESC  -- pretty uniform I must admit. 
; 

-- 9. Calcualte the percentage of total sales each genre contribiutes 
SELECT a.genre, COALESCE(
		SUM(quantity) * 100.0 / (
				SELECT SUM(quantity)
				FROM royalty_sales ), 0) AS perc_of_total_sales
FROM albums as a
JOIN royalty_sales as rs
ON a.album_id = rs.album_id
GROUP BY a.genre
ORDER BY perc_of_total_sales DESC;


-- 10. Who has sold the most albums per specific country 
SELECT ar.country, ar.artist_id, ar.real_name, ar.artist_name,
		COUNT(a.album_id) AS total_album_sold
FROM royalty_sales AS rs
JOIN albums as a
ON rs.album_id = a.album_id
JOIN artists as ar
ON a.artist_id = ar.artist_id
GROUP BY ar.country, ar.artist_id, ar.real_name, ar.artist_name
ORDER BY total_album_sold desc
;

-- 11. How many artist in each country 
SELECT country, count(*) as count
FROM artists
GROUP BY country
ORDER BY count

-- 12. Are there albums / artists that do not generate ANY sales
SELECT *
FROM royalty_sales
WHERE quantity  IS NULL ;  -- no null values so COALESCE is not REALLY neccessary in the next one

SELECT a.album_id,
		a.album_title,
		COALESCE	
			(SUM(rs.quantity), 0)	AS total_sales
FROM albums as a
LEFT JOIN royalty_sales as rs
ON a.album_id = rs.album_id 
GROUP BY a.album_id, a.album_title
HAVING COALESCE	(SUM(rs.quantity), 0) = 0  -- cool all our artist bring in some money 
;


-- 13. Average sales per month for the last 5 years 
SELECT FORMAT(sale_date, 'yyyy MMMM') AS month_year,
AVG(quantity) as avg_sales
FROM royalty_sales
WHERE sale_date >= DATEADD(year, -5, GETDATE() ) 
GROUP BY FORMAT(sale_date, 'yyyy MMMM')
ORDER BY month_year
;

-- 14. Trend of sales for specific album over time
SELECT sale_date, 
SUM(quantity) AS TotalSales
FROM royalty_sales
WHERE album_id = '78377'
GROUP BY sale_date
ORDER BY sale_date;

-- 15. How do sales quantitites vary by date and genre
SELECT sale_date, 
		genre,
		SUM(quantity) AS total_sales
FROM royalty_sales
JOIN albums AS a
ON royalty_sales.album_id = a.album_id
GROUP BY sale_date, genre
ORDER BY sale_date, total_sales DESC;

-- 16. What is the total quatity sold for each store and how does it roll up to the overall total? 
SELECT store, SUM(quantity) AS TotalSales
FROM royalty_sales
GROUP BY store WITH ROLLUP;

-- 17. Quarterly album sales at different dates 
SELECT DATEADD(quarter, DATEDIFF(quarter, 0, sale_date), 0) AS QuarterStart, 
	SUM(quantity) AS total_sales
FROM royalty_sales
GROUP BY DATEADD(quarter, DATEDIFF(quarter, 0, sale_date), 0)
ORDER BY QuarterStart;

-- 18. Let's rank songs based on total sales quantity 
SELECT song_title, SUM(quantity) AS total_sales
FROM royalty_sales
JOIN songs ON royalty_sales.song_id = songs.song_id
GROUP BY song_title
ORDER BY total_sales DESC;

-- 19. Running total of revenue for each artist based on the order of sale dates? 
SELECT sale_date, 
artist_name, real_name,
SUM(quantity * usd_payable) 
	OVER (PARTITION BY ar.artist_id ORDER BY sale_date) AS running_total_rev
FROM royalty_sales as rs
JOIN albums as a ON rs.album_id = a.album_id
JOIN artists as ar ON a.artist_id = ar.artist_id
ORDER BY artist_name, sale_date;


-- 20. calculation of yearly growth rate of total sales and revenue -- using DATACAMP course 
SELECT YEAR(sale_date) AS sales_year, 
       (SUM(quantity) - LAG(SUM(quantity)) OVER (ORDER BY YEAR(sale_date))) 
	   / LAG(SUM(quantity)) OVER (ORDER BY YEAR(sale_date)) 
	   * 100 AS sales_growth_rate,
       (SUM(quantity * usd_payable) - LAG(SUM(quantity * usd_payable)) OVER (ORDER BY YEAR(sale_date))) 
	   / LAG(SUM(quantity * usd_payable)) OVER (ORDER BY YEAR(sale_date)) * 100 AS revenue_growth_rate
FROM royalty_sales
GROUP BY YEAR(sale_date)
ORDER BY sales_year desc;

-- 21. 3 month moving average of sales quanitity
SELECT sale_date, AVG(quantity) OVER (ORDER BY sale_date ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) AS MovingAvgSales
FROM royalty_sales
ORDER BY sale_date;

-- 22. ranking each genre based on total sales quantity
SELECT genre, SUM(quantity) AS TotalSales,
       RANK() OVER (ORDER BY SUM(quantity) DESC) AS GenreRank
FROM albums
JOIN royalty_sales ON albums.album_id = royalty_sales.album_id
GROUP BY genre
ORDER BY TotalSales DESC;


-- 23. running total of tracks sold by album 
SELECT album_id, album_title, 
	SUM(quantity) OVER (PARTITION BY album_id ORDER BY sale_date) AS running_total 
FROM royalty_sales
ORDER BY album_id, sale_date;


-- EXTRA 

-- 24. how many artists is from Poland and how many of them are payed in usd
SELECT country, count(ar.artist_id) as nr_of_artists, count(rs.payable_currency) as currency
FROM royalty_sales as rs
JOIN  albums as a
ON  rs.album_id = a.album_id
JOIN artists as ar
ON a.artist_id = ar.artist_id
WHERE country = 'Poland' AND payable_currency = 'PLN'
GROUP BY country

-- 25. How much profit comes from USA artists? 
SELECT country, ROUND(SUM(rs.usd_payable),2) as total_revenue
FROM artists as ar
JOIN albums as a
on ar.artist_id = a.artist_id 
JOIN royalty_sales as rs
on a.album_id = rs.album_id
WHERE country = 'Brazil' 
GROUP by country 
ORDER BY total_revenue ; 

-- 26. How is the US named in the table 
SELECT *
FROM artists
WHERE country LIKE 'United S%'
;

-- 27. How many countries is there? 
SELECT count(distinct country) 
FROM artists 

-- 28. How many distinct roles is there? 
SELECT count(distinct role)
FROM artists ; -- 22


--29. get aliases from emails
SELECT
    LOWER(Email),
    LOWER(SUBSTRING(email, 1, CHARINDEX('@', Email) - 1)) AS user_name
FROM artists;

-- 30. check the usd_payable column for correct math

select usd_payable, (payable_amt_due * exchange_rate) as calc
from royalty_sales ;

select *
FROM 
	(select usd_payable,
	(payable_amt_due * exchange_rate) as calc
	from royalty_sales ) as comparison
WHERE usd_payable != calc


````
</br>
